// Module: Citygrid.obj
// Source: C:\Copter\source\engine\Citygrid.c
// autogenerated by simcopter_tool from PDB file

// Type: int32_t;

// Type: long;

// Type: char *;

// Type: short;

// Type: /*packed*/ struct MapVert (forward reference);
struct MapVert{ // packed(0x8 bytes) TI: 0x2e89
	/*+0x0*/   int32_t x;
	/*+0x4*/   int32_t y;
};

// Type: /*packed*/ struct GridFaceHdrType (forward reference);
struct GridFaceHdrType{ // packed(0x18 bytes) TI: 0x2ed8
	/*+0x0*/   long TextureId;
	/*+0x4*/   long PlotterId;
	/*+0x8*/   long Pcount;
	/*+0xc*/   long Ccount;
	/*+0x10*/  void * __ptr32 Ppointer;
	/*+0x14*/  void * __ptr32 Cpointer;
};

// Type: /*packed*/ struct Point3d (forward reference);
struct Point3d{ // packed(0xc bytes) TI: 0x18b0
	/*+0x0*/   int32_t x;
	/*+0x4*/   int32_t y;
	/*+0x8*/   int32_t z;
};

// Type: long *;

// Type: void;



// Contribution: 1:000d5b40-000d62f3 Module: 141, 16 byte alignment, code, execute, read, 
// FUNCTION: COPTER_D 0x004d6b40
short VRInitGridObj(long ViewSize) {
	// StaticLocal: 0x0059d2d8
	static int32_t b_FirstTime = 1;
	;
	/*bp-0x4*/   long plotter;
	/*bp-0x8*/   long * iptr;
	/*bp-0xc*/   /*packed*/ struct Point3d *v;
	/*bp-0x10*/  long ul;
	/*bp-0x14*/  /*packed*/ struct GridFaceHdrType *gf;
	/*bp-0x18*/  long x;
	/*bp-0x1c*/  int32_t z_val;
	/*bp-0x20*/  int32_t x_val;
	/*bp-0x24*/  /*packed*/ struct MapVert *mapv;
	/*bp-0x28*/  long y;
	/*bp-0x2c*/  int32_t vert_inc;
	/*bp-0x30*/  short i;
	/*bp-0x34*/  short j;
	/*bp-0x38*/  int32_t x_start;
	/*bp-0x3c*/  long goff;
	/*bp-0x40*/  char * dataptr;

// LINE 132:
	plotter = 0x0;
// LINE 134:
	__asm        cmp    b_FirstTime, 0;
	__asm        je     _T38;
// LINE 136:
	InitGridPool();
// LINE 137:
	__asm        cmp    S_gridmempool, 0;
	__asm        jge    _T38;
// LINE 138:
	return 0x1;
// LINE 143:
_T38:
	__asm        jmp    _T40;
// LINE 144:
	ViewSize++;
// LINE 146:
_T40:
	__asm        cmp    ViewSize, 0xD;
	__asm        jge    _T51;
// LINE 147:
	ViewSize = 0xd;
// LINE 153:
_T51:
	__asm        cmp    ViewSize, 0x3D;
	__asm        jle    _T6a;
// LINE 155:
	ViewSize = 0x3d;
// LINE 156:
	return 0x0;
// LINE 158:
_T6a:
	__asm        mov    eax, ViewSize;
	__asm        inc    eax;
	__asm        mov    G_VertDim, eax;
// LINE 159:
	G_FaceDim = (ViewSize + ViewSize);
// LINE 160:
	vert_inc = 0x400000;
// LINE 166:
	G_ViewSize = ViewSize;
// LINE 171:
	GridNVerts = (G_VertDim * G_VertDim);
// LINE 172:
	GridNFaces = ((G_ViewSize * G_ViewSize) + (G_ViewSize * G_ViewSize));
// LINE 177:
	GridFaceSize = 0x3c;
// LINE 193:
	goff = GridNFaces;
// LINE 194:
	__asm        mov    eax, goff;
	__asm        lea    eax, [eax+eax*2];
	__asm        mov    goff, eax;
// LINE 195:
	__asm        mov    eax, goff;
	__asm        shl    eax, 2;
	__asm        lea    eax, [eax+eax*4];
	__asm        mov    goff, eax;
// LINE 200:
	VRFreeGridObj();
// LINE 201:
	GridRotate = S2AllocMem1(0x0, (GridNVerts << 0x4), 0x59d2dc, S_gridmempool);
// LINE 202:
	GridRotateEnd = ((GridNVerts << 0x4) + GridRotate);
// LINE 203:
	GridProject = S2AllocMem1(0x0, goff, 0x59d2e4, S_gridmempool);
// LINE 204:
	GridProjectEnd = (goff + GridProject);
// LINE 206:
	__asm        push   0;
	__asm        mov    eax, GridNVerts;
	__asm        lea    eax, [eax+eax*2];
	__asm        shl    eax, 2;
	__asm        push   eax;
	__asm        push   0x59D2F0;
	__asm        mov    eax, S_gridmempool;
	__asm        push   eax;
	__asm        call   S2AllocMem1;
	__asm        add    esp, 0x10;
	__asm        mov    GridVerts, eax;
// LINE 207:
	__asm        mov    eax, GridNVerts;
	__asm        lea    eax, [eax+eax*2];
	__asm        shl    eax, 2;
	__asm        add    eax, GridVerts;
	__asm        mov    GridVertsEnd, eax;
// LINE 208:
	GridSortFaces = S2AllocMem1(0x0, (GridNFaces << 0x2), 0x59d2fc, S_gridmempool);
// LINE 209:
	GridSortFacesEnd = ((GridNFaces << 0x2) + GridSortFaces);
// LINE 210:
	GridFaces = S2AllocMem1(0x0, (GridFaceSize * GridNFaces), 0x59d308, S_gridmempool);
// LINE 211:
	GridFacesEnd = ((GridFaceSize * GridNFaces) + GridFaces);
// LINE 213:
	WhereIsIt = S2AllocMem1(0x0, (GridNVerts << 0x2), 0x59d314, S_gridmempool);
// LINE 214:
	WhereIsItEnd = ((GridNVerts << 0x2) + WhereIsIt);
// LINE 215:
	IsRotated = S2AllocMem1(0x0, GridNVerts, 0x59d320, S_gridmempool);
// LINE 216:
	IsRotatedEnd = (GridNVerts + IsRotated);
// LINE 218:
	GridSortCells = S2AllocMem1(0x0, (((G_ViewSize * G_ViewSize) << 0x2) >> 0x1), 0x59d32c, S_gridmempool);
// LINE 219:
	GridSortCellsEnd = ((((G_ViewSize * G_ViewSize) << 0x2) >> 0x1) + GridSortCells);
// LINE 220:
	GridCellAddrs = S2AllocMem1(0x0, (((G_ViewSize * G_ViewSize) << 0x2) >> 0x1), 0x59d338, S_gridmempool);
// LINE 221:
	GridCellAddrsEnd = ((((G_ViewSize * G_ViewSize) << 0x2) >> 0x1) + GridCellAddrs);
// LINE 225:
	goff = GridFaces;
// LINE 226:
_FOR_2fc:
	for (y = 0x0; (G_ViewSize > y); y++) {
		// LINE 228:
		_FOR_31a:
			for (x = 0x0; (G_ViewSize > x); x++) {
				// LINE 230:
					__asm        mov    eax, goff;
					__asm        mov    ecx, y;
					__asm        mov    edx, ecx;
					__asm        lea    ecx, [ecx+ecx*2];
					__asm        lea    ecx, [ecx+ecx*8];
					__asm        lea    ecx, [ecx+ecx*8];
					__asm        add    ecx, edx;
					__asm        mov    edx, x;
					__asm        mov    GridCellOffsets[0][ecx+edx*4], eax;
				// LINE 231:
					goff += (GridFaceSize + GridFaceSize);
			}
		// LINE 233:
		_T358:
	}
// LINE 240:
_T35d:
	CVerts[0][0] = 0x0;
// LINE 241:
	CVerts[0][1] = 0x1;
// LINE 242:
	CVerts[0][2] = 0x2;
// LINE 243:
	CVerts[1][0] = G_VertDim;
// LINE 244:
	__asm        mov    eax, G_VertDim;
	__asm        inc    eax;
	__asm        mov    CVerts[1][1], eax;
// LINE 245:
	CVerts[1][2] = (G_VertDim + 0x2);
// LINE 246:
	CVerts[2][0] = (G_VertDim + G_VertDim);
// LINE 247:
	__asm        mov    eax, G_VertDim;
	__asm        add    eax, eax;
	__asm        inc    eax;
	__asm        mov    CVerts[2][1], eax;
// LINE 248:
	CVerts[2][2] = ((G_VertDim + G_VertDim) + 0x2);
// LINE 255:
	__asm        push   0x400000;
	__asm        mov    eax, G_ViewSize;
	__asm        cdq;
	__asm        sub    eax, edx;
	__asm        sar    eax, 1;
	__asm        shl    eax, 0x10;
	__asm        push   eax;
	__asm        call   0x004D19BD;
	__asm        add    esp, 8;
	__asm        mov    z_val, eax;
// LINE 256:
	__asm        push   0x400000;
	__asm        mov    eax, G_ViewSize;
	__asm        cdq;
	__asm        sub    eax, edx;
	__asm        sar    eax, 1;
	__asm        shl    eax, 0x10;
	__asm        push   eax;
	__asm        call   0x004D19BD;
	__asm        add    esp, 8;
	__asm        neg    eax;
	__asm        mov    x_start, eax;
// LINE 257:
	v = GridVerts;
// LINE 258:
_FOR_418:
	for (i = 0x0; (reinterpret_cast<int16_t>(i) < G_VertDim); i++) {
		// LINE 260:
			x_val = x_start;
		// LINE 261:
		_FOR_43d:
			for (j = 0x0; (reinterpret_cast<int16_t>(j) < G_VertDim); j++) {
				// LINE 263:
					v->x = x_val;
				// LINE 264:
					v->z = z_val;
				// LINE 265:
					x_val += vert_inc;
				// LINE 266:
					v += 0xc;
			}
		// LINE 268:
		_T471:
			__asm        xor    eax, eax;
			__asm        sub    eax, vert_inc;
			__asm        neg    eax;
			__asm        sub    z_val, eax;
	}
// LINE 275:
_T480:
	dataptr = GridFaces;
// LINE 276:
_FOR_494:
	for (y = 0x0; (G_ViewSize > y); y++) {
		// LINE 278:
		_FOR_4b2:
			for (x = 0x0; (G_ViewSize > x); x++) {
				// LINE 281:
					ul = ((G_VertDim * y) + x);
				// LINE 303:
				_FOR_4de:
					for (i = 0x0; (reinterpret_cast<int16_t>(i) < 0x2); i++) {
						// LINE 305:
							gf = dataptr;
						// LINE 306:
							iptr = (dataptr + 0x18);
						// LINE 308:
							mapv = (dataptr + 0x24);
						// LINE 309:
							dataptr += GridFaceSize;
						// LINE 311:
							gf->PlotterId = plotter;
						// LINE 312:
							gf->TextureId = 0x0;
						// LINE 314:
							__asm        movsx  eax, i;
							__asm        mov    [ebp-0x44], eax;
							__asm        jmp    _T61c;
						// LINE 317:
						_T52d:
							iptr[0] = (CVerts[0][0] + ul);
							iptr += 0x4;
						// LINE 318:
							iptr[0] = (CVerts[0][1] + ul);
							iptr += 0x4;
						// LINE 319:
							iptr[0] = (CVerts[1][0] + ul);
						// LINE 320:
							mapv->x = 0x8000;
						// LINE 321:
							mapv->y = 0x8000;
						// LINE 322:
							mapv += 0x8;
						// LINE 323:
							mapv->x = 0x1f8000;
						// LINE 324:
							mapv->y = 0x8000;
						// LINE 325:
							mapv += 0x8;
						// LINE 326:
							mapv->x = 0x8000;
						// LINE 327:
							mapv->y = 0x1f8000;
						// LINE 328:
							__asm        jmp    _T635;
						// LINE 330:
						_T5a2:
							iptr[0] = (CVerts[0][1] + ul);
							iptr += 0x4;
						// LINE 331:
							iptr[0] = (CVerts[1][1] + ul);
							iptr += 0x4;
						// LINE 332:
							iptr[0] = (CVerts[1][0] + ul);
						// LINE 333:
							mapv->x = 0x1f8000;
						// LINE 334:
							mapv->y = 0x8000;
						// LINE 335:
							mapv += 0x8;
						// LINE 336:
							mapv->x = 0x1f8000;
						// LINE 337:
							mapv->y = 0x1f8000;
						// LINE 338:
							mapv += 0x8;
						// LINE 339:
							mapv->x = 0x8000;
						// LINE 340:
							mapv->y = 0x1f8000;
						// LINE 341:
							__asm        jmp    _T635;
						// LINE 342:
							__asm        jmp    _T635;
						_T61c:
							__asm        cmp    dword ptr [ebp-0x44], 0;
							__asm        je     _T52d;

							__asm        cmp    dword ptr [ebp-0x44], 1;
							__asm        je     _T5a2;

							__asm        jmp    _T635;
						// LINE 343:
						_T635:
					}
				// LINE 344:
				_T63a:
			}
		// LINE 345:
		_T63f:
	}
// LINE 350:
_T644:
	__asm        cmp    b_FirstTime, 0;
	__asm        je     _T68a;
// LINE 352:
	__asm        mov    eax, 0x666300;
	__asm        add    eax, 0x18;
	__asm        push   eax;
	__asm        call   0x004D1FF1;
	__asm        add    esp, 4;
// LINE 353:
	GridPos.loc.z = 0x0;
	GridPos.loc.y = GridPos.loc.z;
	GridPos.loc.x = GridPos.loc.y;
// LINE 354:
	b_FirstTime = 0x0;
// LINE 357:
_T68a:
	return 0x0;
// LINE 358:
}

// FUNCTION: COPTER_D 0x004d71d7
void VRFreeGridObj() {
// LINE 364:
	S2AllocReset(S_gridmempool);
// LINE 365:
}

// FUNCTION: COPTER_D 0x004d71f0
void InitGridPool() {
	/*bp-0x4*/   int32_t tempSize;
	/*bp-0x8*/   long GridPoolSize;
	/*bp-0xc*/   long goff;

// LINE 371:
	GridPoolSize = 0x0;
// LINE 372:
	tempSize = G_ViewSize;
// LINE 376:
	G_ViewSize = 0x3d;
// LINE 377:
	__asm        mov    eax, G_ViewSize;
	__asm        inc    eax;
	__asm        mov    G_VertDim, eax;
// LINE 378:
	G_FaceDim = (G_ViewSize + G_ViewSize);
// LINE 383:
	GridNVerts = (G_VertDim * G_VertDim);
// LINE 384:
	GridNFaces = ((G_ViewSize * G_ViewSize) + (G_ViewSize * G_ViewSize));
// LINE 390:
	GridFaceSize = 0x3c;
// LINE 398:
	goff = GridNFaces;
// LINE 399:
	__asm        mov    eax, goff;
	__asm        lea    eax, [eax+eax*2];
	__asm        mov    goff, eax;
// LINE 400:
	__asm        mov    eax, goff;
	__asm        shl    eax, 2;
	__asm        lea    eax, [eax+eax*4];
	__asm        mov    goff, eax;
// LINE 403:
	GridPoolSize = (GridNVerts << 0x4);
// LINE 404:
	GridPoolSize += goff;
// LINE 405:
	__asm        mov    eax, GridNVerts;
	__asm        lea    eax, [eax+eax*2];
	__asm        shl    eax, 2;
	__asm        add    eax, GridPoolSize;
	__asm        mov    GridPoolSize, eax;
// LINE 406:
	GridPoolSize = ((GridNFaces << 0x2) + GridPoolSize);
// LINE 407:
	GridPoolSize += (GridFaceSize * GridNFaces);
// LINE 408:
	GridPoolSize = ((GridNVerts << 0x2) + GridPoolSize);
// LINE 409:
	GridPoolSize += GridNVerts;
// LINE 410:
	GridPoolSize = (((G_ViewSize * G_ViewSize) << 0x2) + GridPoolSize);
// LINE 412:
	S_gridmempool = S2AllocPool(GridPoolSize);
// LINE 413:
}



// Contribution: 3:000062d4-00006342 Module: 141, 4 byte alignment, initialized_data, read, write, 
// GLOBAL: COPTER_D 0x0059d2d4
static int32_t S_gridmempool = -1;



// Unknown globals:
// The PDB was slightly corrupted and we aren't sure which file these globals belong to.

// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x0066286c
/*packed*/ struct Clip2d *dbgvertptr; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x006662f4
long dbgverts; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x0066639c
void * __ptr32 GridSortFacesEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00666394
void * __ptr32 GridFacesEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00666380
/*packed*/ struct _CELL_INFO ***GridCellAddrsEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00666378
/*packed*/ struct _CELL_INFO **GridSortCellsEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00666374
/*packed*/ struct _CELL_INFO ***GridCellAddrs; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00666370
/*packed*/ struct Project3d **WhereIsItEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00666358
long G_VertDim; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x006662a4
void * __ptr32 GridRotateEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00662880
long GridCellOffsets[61][61]; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00662874
/*packed*/ struct Point3d *GridVertsEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00662868
char * G_fog; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00662864
unsigned char * IsRotatedEnd; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00662840
long CVerts[3][3]; // Contrib missing


// WARNING: this global might actually belong to: gridrend.asm
// GLOBAL: COPTER_D 0x00662830
long G_FaceDim; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662834
char * G_fogbase; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662868
char * G_fog; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662818
int32_t G_fogZ1; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x0066281c
int32_t G_plotglob; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666388
int32_t G_deltafogZ; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666398
/*packed*/ struct Project3d **WhereIsIt; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666370
/*packed*/ struct Project3d **WhereIsItEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666368
/*packed*/ struct Point3d *GridVerts; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662874
/*packed*/ struct Point3d *GridVertsEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666360
unsigned char * IsRotated; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662864
unsigned char * IsRotatedEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662828
void * __ptr32 GridRotate; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x006662a4
void * __ptr32 GridRotateEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x006662f0
void * __ptr32 GridProject; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x006662b0
int32_t GridMat[4][4]; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666364
void * __ptr32 GridSortFaces; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x0066639c
void * __ptr32 GridSortFacesEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662814
long GridNVerts; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x0066637c
long GridNFaces; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x006662a8
long GridFaceSize; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666300
/*packed*/ struct VRview GridPos; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662824
void * __ptr32 GridFaces; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666384
/*packed*/ struct _CELL_INFO **GridSortCells; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666378
/*packed*/ struct _CELL_INFO **GridSortCellsEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666374
/*packed*/ struct _CELL_INFO ***GridCellAddrs; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666380
/*packed*/ struct _CELL_INFO ***GridCellAddrsEnd; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666358
long G_VertDim; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662830
long G_FaceDim; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00662880
long GridCellOffsets[61][61]; // Contrib missing


// WARNING: this global might actually belong to: vrcalls.asm
// GLOBAL: COPTER_D 0x00666394
void * __ptr32 GridFacesEnd; // Contrib missing

